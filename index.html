<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladder Logic Security Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- D3.js for visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Cytoscape.js for graph operations and visualization -->
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <style>
        .graph-container {
            height: 300px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        // Simple React app
        const { useState, useEffect, useRef } = React;

        // GraphViz component to visualize graph data
        const GraphViz = ({ graphData, highlightedNodes = [] }) => {
            const containerRef = useRef(null);
            const cy = useRef(null);
            
            useEffect(() => {
                if (!graphData || !containerRef.current) {
                    // Clear any existing graph if data is missing
                    if (cy.current) {
                        cy.current.destroy();
                        cy.current = null;
                    }
                    return;
                }
                
                try {
                    // Make sure we have at least some nodes and edges
                    const elements = [
                        // Nodes
                        ...(graphData.nodes || []).map(node => ({
                            data: { 
                                id: node.id, 
                                label: node.label || node.id,
                                type: node.type 
                            }
                        })),
                        
                        // Edges
                        ...(graphData.edges || []).map(edge => ({
                            data: { 
                                id: `${edge.source}-${edge.target}`, 
                                source: edge.source, 
                                target: edge.target 
                            }
                        }))
                    ];
                    
                    // If there aren't any elements, don't try to render the graph
                    if (elements.length === 0) {
                        console.log("No elements to display in graph");
                        return;
                    }
                    
                    // Initialize cytoscape
                    cy.current = cytoscape({
                        container: containerRef.current,
                        elements: elements,
                        style: [
                            {
                                selector: 'node',
                                style: {
                                    'background-color': ele => {
                                        const type = ele.data('type');
                                        if (type === 'rung') return '#f97316'; // orange
                                        if (type === 'condition') return '#4ade80'; // green
                                        if (type === 'instruction') return '#60a5fa'; // blue
                                        if (type === 'special') return '#c084fc'; // purple
                                        return '#94a3b8'; // gray
                                    },
                                    'label': 'data(label)',
                                    'text-valign': 'center',
                                    'text-halign': 'center',
                                    'font-size': '10px',
                                    'width': 30,
                                    'height': 30,
                                    'border-width': ele => 
                                        highlightedNodes.includes(ele.id()) ? 3 : 0,
                                    'border-color': '#f43f5e' // rose
                                }
                            },
                            {
                                selector: 'edge',
                                style: {
                                    'width': 2,
                                    'line-color': '#94a3b8',
                                    'target-arrow-color': '#94a3b8',
                                    'target-arrow-shape': 'triangle',
                                    'curve-style': 'bezier'
                                }
                            }
                        ],
                        layout: {
                            name: 'cose',
                            padding: 20,
                            nodeRepulsion: 8000,
                            nodeDimensionsIncludeLabels: true
                        }
                    });
                } catch (error) {
                    console.error("Error initializing cytoscape graph:", error);
                }
                
                // Clean up
                return () => {
                    if (cy.current) {
                        cy.current.destroy();
                    }
                };
            }, [graphData, highlightedNodes]);
            
            return (
                <div ref={containerRef} className="graph-container">
                    {!graphData && (
                        <div className="flex items-center justify-center h-full bg-gray-100 text-gray-500">
                            No graph data available
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [file, setFile] = useState(null);
            const [fileContent, setFileContent] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [selectedVulnerability, setSelectedVulnerability] = useState(null);
            const [programGraph, setProgramGraph] = useState(null);
            const [convertingXML, setConvertingXML] = useState(false);
            const [conversionResult, setConversionResult] = useState(null);
            const [activeTab, setActiveTab] = useState('overview');

            // Ladder logic parser - converts ladder logic text to a graph representation
            const parseLadderLogic = (content) => {
                const lines = content.split('\n');
                const nodes = [];
                const edges = [];
                let nodeId = 1;
                let rungId = 1;
                
                // Track existing nodes to avoid duplicates
                const nodeMap = new Map();
                
                // Parse each line to build the graph
                lines.forEach((line, i) => {
                    const trimmedLine = line.trim();
                    
                    // Skip empty lines and comments-only lines
                    if (!trimmedLine || trimmedLine.startsWith('//')) {
                        return;
                    }
                    
                    // Create rung node for each logic line
                    const currentRungId = `R${rungId}`;
                    if (!nodeMap.has(currentRungId)) {
                        nodes.push({
                            id: currentRungId,
                            label: `Rung ${rungId}`,
                            type: 'rung',
                            line: i + 1
                        });
                        nodeMap.set(currentRungId, true);
                    }
                    
                    // Split the line into tokens and create nodes for each instruction
                    const tokens = trimmedLine.split(/\s+/);
                    let prevNodeId = currentRungId;
                    
                    tokens.forEach(token => {
                        if (['XIC', 'XIO', 'OTE', 'OTU', 'MOV', 'TON', 'ADD', 'SUB', 'DIV', 'CTU', 'PID', 'OSR', 'LIM', 'EQU', 'GRT'].includes(token.toUpperCase())) {
                            // Instruction start
                            const instructionType = token.toUpperCase() === 'XIC' || token.toUpperCase() === 'XIO' 
                                ? 'condition' : 'instruction';
                            
                            const currentNodeId = `I${nodeId}`;
                            nodes.push({
                                id: currentNodeId,
                                label: token,
                                type: instructionType,
                                line: i + 1
                            });
                            
                            // Connect to previous node
                            edges.push({
                                source: prevNodeId,
                                target: currentNodeId
                            });
                            
                            prevNodeId = currentNodeId;
                            nodeId++; // Increment nodeId after using it
                        }
                    });
                    
                    rungId++;
                });
                
                return { nodes, edges };
            };

            // Define vulnerability pattern graphs
            const vulnerabilityPatterns = [
                // V-001: Unconditional coil overwrite
                {
                    id: 1,
                    code: "V-001",
                    name: "Unconditional coil overwrite",
                    description: "Ladder logic that unconditionally overwrites an output coil without proper conditions.",
                    color: "#FF5252",
                    pattern: {
                        nodes: [
                            { id: "R1", type: "rung" },
                            { id: "I1", type: "instruction", label: "OTE" }
                        ],
                        edges: [
                            { source: "R1", target: "I1" }
                        ]
                    }
                },
                // V-002: Shadow reset (seal-in loop)
                {
                    id: 2,
                    code: "V-002",
                    name: "Shadow reset (seal-in loop)",
                    description: "A circuit that resets a seal-in loop without proper validation.",
                    color: "#FF9800",
                    pattern: {
                        nodes: [
                            { id: "I1", type: "instruction", label: "OTU" }
                        ],
                        edges: []
                    }
                },
                // V-003: Timer bomb (preset from writable tag)
                {
                    id: 3,
                    code: "V-003",
                    name: "Timer bomb (preset from writable tag)",
                    description: "Timer preset values come from HMI-writable tags without validation.",
                    color: "#FFEB3B",
                    pattern: {
                        nodes: [
                            { id: "I1", type: "instruction", label: "MOV" },
                            { id: "I2", type: "instruction", label: "TON" }
                        ],
                        edges: [
                            { source: "I1", target: "I2" }
                        ]
                    }
                },
                // V-004: Unsafe mode override (blind MOV 1)
                {
                    id: 4,
                    code: "V-004",
                    name: "Unsafe mode override (blind MOV 1)",
                    description: "Using MOV 1 to override safety or diagnostic tags.",
                    color: "#8BC34A",
                    pattern: {
                        nodes: [
                            { id: "I1", type: "instruction", label: "MOV" }
                        ],
                        edges: []
                    }
                },
                // V-005: Monolithic main block
                {
                    id: 5,
                    code: "V-005",
                    name: "Monolithic main block",
                    description: "Main routine with more than 500 nodes, making it harder to maintain and secure.",
                    color: "#00BCD4",
                    pattern: {
                        nodes: [], // This is detected by node count, not pattern
                        edges: []
                    }
                },
                // V-006: Unvalidated timer/counter preset
                {
                    id: 6,
                    code: "V-006",
                    name: "Unvalidated timer/counter preset",
                    description: "Timer or counter values without validation logic.",
                    color: "#3F51B5",
                    pattern: {
                        nodes: [
                            { id: "I1", type: "instruction", label: "MOV" },
                            { id: "I2", type: "instruction", label: "CTU" }
                        ],
                        edges: [
                            { source: "I1", target: "I2" }
                        ]
                    }
                },
                // V-007: Mutually-exclusive coils asserted
                {
                    id: 7,
                    code: "V-007",
                    name: "Mutually-exclusive coils asserted",
                    description: "Antagonistic coil pairs (e.g., Motor_FWD and Motor_REV) asserted simultaneously.",
                    color: "#9C27B0",
                    pattern: {
                        nodes: [
                            { id: "I1", type: "instruction", label: "OTE" },
                            { id: "I2", type: "instruction", label: "OTE" }
                        ],
                        edges: []
                    }
                },
                // V-008: HMI blind-write
                {
                    id: 8,
                    code: "V-008",
                    name: "HMI blind-write",
                    description: "HMI writing to PLC variables without validation.",
                    color: "#E91E63",
                    pattern: {
                        nodes: [], // Detected by comment analysis, not graph pattern
                        edges: []
                    }
                },
                // V-009: Out-of-bounds indirection
                {
                    id: 9,
                    code: "V-009",
                    name: "Out-of-bounds indirection",
                    description: "Array indexing without bounds checks.",
                    color: "#795548",
                    pattern: {
                        nodes: [
                            { id: "I1", type: "instruction", label: "MOV" }
                        ],
                        edges: []
                    }
                },
                // V-010: Rapid toggle / missing debounce
                {
                    id: 10,
                    code: "V-010",
                    name: "Rapid toggle / missing debounce",
                    description: "Paired outputs without debounce timer protection.",
                    color: "#607D8B",
                    pattern: {
                        nodes: [
                            { id: "C1", type: "condition", label: "XIC" },
                            { id: "I1", type: "instruction", label: "OTE" }
                        ],
                        edges: [
                            { source: "C1", target: "I1" }
                        ]
                    }
                },
                // V-011: Missing plausibility cross-check
                {
                    id: 11,
                    code: "V-011",
                    name: "Missing plausibility cross-check",
                    description: "Missing validation between redundant sensor tags.",
                    color: "#F44336",
                    pattern: {
                        nodes: [
                            { id: "C1", type: "condition" },
                            { id: "I1", type: "instruction", label: "OTE" }
                        ],
                        edges: [
                            { source: "C1", target: "I1" }
                        ]
                    }
                },
                // V-012: No physical-limit clamp
                {
                    id: 12,
                    code: "V-012",
                    name: "No physical-limit clamp",
                    description: "PID blocks without physical limits on operator inputs.",
                    color: "#FFC107",
                    pattern: {
                        nodes: [
                            { id: "I1", type: "instruction", label: "MOV" },
                            { id: "I2", type: "instruction", label: "PID" }
                        ],
                        edges: [
                            { source: "I1", target: "I2" }
                        ]
                    }
                },
                // V-013: Flag-blind math
                {
                    id: 13,
                    code: "V-013",
                    name: "Flag-blind math",
                    description: "Math operations without status bit checking for alarms.",
                    color: "#4CAF50",
                    pattern: {
                        nodes: [
                            { id: "I1", type: "instruction", label: "ADD" }
                        ],
                        edges: []
                    }
                },
                // V-014: Alert-trap bypass
                {
                    id: 14,
                    code: "V-014",
                    name: "Alert-trap bypass",
                    description: "Alarm coil written from multiple rungs where one lacks conditions.",
                    color: "#2196F3",
                    pattern: {
                        nodes: [
                            { id: "R1", type: "rung" },
                            { id: "R2", type: "rung" },
                            { id: "I1", type: "instruction", label: "OTE" },
                            { id: "I2", type: "instruction", label: "OTE" }
                        ],
                        edges: [
                            { source: "R1", target: "I1" },
                            { source: "R2", target: "I2" }
                        ]
                    }
                }
            ];

            // Simple mock data
            const generateMockData = () => {
                // Create a smarter mock that shows actual examples from the sample ladder logic
                const getSnippetForPattern = (pattern) => {
                    switch(pattern.code) {
                        case "V-001":
                            return {
                                lineStart: 10,
                                lineEnd: 10,
                                code: "// Unconditional coil overwrite\nOTE Critical_Output",
                                severity: "High"
                            };
                        case "V-002":
                            return {
                                lineStart: 15,
                                lineEnd: 17,
                                code: "// Shadow reset (seal-in loop)\nXIC Alarm_Condition OTE Alarm_Active\nXIC Alarm_Active OTE Alarm_Active\nXIC Reset_Button OTU Alarm_Active",
                                severity: "Medium"
                            };
                        case "V-003":
                            return {
                                lineStart: 22,
                                lineEnd: 23,
                                code: "// Timer preset from writable tag\nMOV HMI_Value Timer1.PRE\nTON Timer1",
                                severity: "High"
                            };
                        case "V-004":
                            return {
                                lineStart: 27,
                                lineEnd: 28,
                                code: "// Unsafe mode override\nXIC Maintenance_Mode\nMOV 1 Safety_Bypass",
                                severity: "High"
                            };
                        case "V-005":
                            return {
                                lineStart: 33,
                                lineEnd: 35,
                                code: "// Monolithic main block\nXIC Input_1 OTE Output_1\nXIC Input_2 OTE Output_2\nXIC Input_3 OTE Output_3\n// ... 500+ more lines ...",
                                severity: "Medium"
                            };
                        case "V-006":
                            return {
                                lineStart: 41,
                                lineEnd: 42,
                                code: "// Unvalidated timer/counter preset\nMOV User_Counter_Input CTU_1.PRE\nCTU CTU_1",
                                severity: "Medium"
                            };
                        case "V-007":
                            return {
                                lineStart: 47,
                                lineEnd: 48,
                                code: "// Mutually-exclusive coils asserted\nXIC Forward_Button OTE Motor_Forward\nXIC Reverse_Button OTE Motor_Reverse",
                                severity: "Medium"
                            };
                        case "V-008":
                            return {
                                lineStart: 53,
                                lineEnd: 54,
                                code: "// HMI blind-write\n// HMI_Tag directly mapped to Critical_Setpoint without PLC validation",
                                severity: "High"
                            };
                        case "V-009":
                            return {
                                lineStart: 59,
                                lineEnd: 59,
                                code: "// Array indexing without bounds check\nMOV Index Array[Index]",
                                severity: "Medium"
                            };
                        case "V-010":
                            return {
                                lineStart: 64,
                                lineEnd: 64,
                                code: "// Output toggling without debounce\nXIC Button_Input OTE Toggle_Output",
                                severity: "Low"
                            };
                        case "V-011":
                            return {
                                lineStart: 69,
                                lineEnd: 69,
                                code: "// Redundant sensors without cross-check\nXIC Sensor_1 OTE Process_Running",
                                severity: "Medium"
                            };
                        case "V-012":
                            return {
                                lineStart: 74,
                                lineEnd: 75,
                                code: "// PID without min/max clamping\nMOV Operator_Input PID_Setpoint\nPID PID_Controller",
                                severity: "Medium"
                            };
                        case "V-013":
                            return {
                                lineStart: 80,
                                lineEnd: 81,
                                code: "// Math without status checking\nDIV Value_1 Value_2 Result\nADD Value_3 Value_4 Sum",
                                severity: "High"
                            };
                        case "V-014":
                            return {
                                lineStart: 86,
                                lineEnd: 89,
                                code: "// Alert-trap bypass\n// Rung 13 - Alarm with conditions\nXIC Condition_1 XIC Condition_2 OTE System_Alarm\n// Rung 14 - Same alarm without conditions\nOTE System_Alarm",
                                severity: "High"
                            };
                        default:
                            return {
                                lineStart: 1,
                                lineEnd: 1,
                                code: `// Sample vulnerable code for ${pattern.name}`,
                                severity: "Medium"
                            };
                    }
                };

                return vulnerabilityPatterns.map(pattern => {
                    const snippet = getSnippetForPattern(pattern);
                    // Randomly determine if found, but with higher probability for known pattern
                    const isFound = Math.random() > 0.2;
                    
                    return {
                        patternId: pattern.id,
                        code: pattern.code,
                        name: pattern.name,
                        description: pattern.description,
                        found: isFound,
                        occurrences: isFound ? Math.floor(Math.random() * 2) + 1 : 0,
                        snippets: isFound ? [
                            {
                                id: `${pattern.code}-1`,
                                lineStart: snippet.lineStart,
                                lineEnd: snippet.lineEnd,
                                code: snippet.code,
                                severity: snippet.severity
                            }
                        ] : []
                    };
                });
            };

            const handleFileChange = (event) => {
                if (event.target.files && event.target.files.length > 0) {
                    const selectedFile = event.target.files[0];
                    setFile(selectedFile);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (e.target) {
                            setFileContent(e.target.result);
                        }
                    };
                    reader.readAsText(selectedFile);
                }
            };

            const analyzeWithGraphIsomorphism = (content) => {
                // Parse ladder logic into a graph
                const programGraph = parseLadderLogic(content);
                
                // Perform specialized detection for each vulnerability pattern
                return vulnerabilityPatterns.map(pattern => {
                    let found = false;
                    let occurrences = 0;
                    let snippets = [];
                    let matchedSubgraphs = [];
                    
                    // Special case for V-005 (Monolithic block) - check node count
                    if (pattern.code === "V-005") {
                        const nodeCount = programGraph.nodes.length;
                        found = nodeCount > 30; // Lowered for demo, would be 500+ in real code
                        if (found) {
                            occurrences = 1;
                            snippets = [{
                                id: `${pattern.code}-1`,
                                lineStart: 1,
                                lineEnd: 10,
                                code: content.split('\n').slice(0, 10).join('\n') + '\n// ... (large routine with ' + nodeCount + ' nodes)',
                                severity: "Medium"
                            }];
                            matchedSubgraphs = [programGraph];
                        }
                    }
                    // Special case for HMI blind-write - check for comments
                    else if (pattern.code === "V-008") {
                        const lines = content.split('\n');
                        const hmiCommentLines = lines
                            .map((line, i) => ({ line, index: i }))
                            .filter(({ line }) => 
                                line.toLowerCase().includes('hmi') && 
                                (line.toLowerCase().includes('write') || line.toLowerCase().includes('tag'))
                            );
                            
                        found = hmiCommentLines.length > 0;
                        occurrences = hmiCommentLines.length;
                        
                        if (found) {
                            snippets = hmiCommentLines.map(({ line, index }, i) => ({
                                id: `${pattern.code}-${i+1}`,
                                lineStart: index + 1,
                                lineEnd: index + 1,
                                code: line,
                                severity: "High"
                            }));
                            
                            // Create mock subgraphs
                            matchedSubgraphs = hmiCommentLines.map(() => ({
                                nodes: [
                                    { id: "HMI1", type: "special", label: "HMI" },
                                    { id: "PLC1", type: "special", label: "PLC Variable" }
                                ],
                                edges: [
                                    { source: "HMI1", target: "PLC1" }
                                ]
                            }));
                        }
                    }
                    // Normal subgraph isomorphism check
                    else if (pattern.pattern.nodes.length > 0) {
                        // Simplistic isomorphism - in real code would use a proper algorithm
                        found = isSubgraphIsomorphic(programGraph, pattern.pattern);
                        
                        if (found) {
                            // Find instances in the code where pattern occurs
                            const patternKeywords = getKeywordsForPattern(pattern.code);
                            const lines = content.split('\n');
                            
                            let matchIndices = [];
                            lines.forEach((line, i) => {
                                const lowerLine = line.toLowerCase();
                                if (patternKeywords.some(keyword => lowerLine.includes(keyword.toLowerCase()))) {
                                    matchIndices.push(i);
                                }
                            });
                            
                            // Group adjacent lines
                            const lineGroups = [];
                            let currentGroup = [matchIndices[0]];
                            
                            for (let i = 1; i < matchIndices.length; i++) {
                                if (matchIndices[i] === matchIndices[i-1] + 1) {
                                    currentGroup.push(matchIndices[i]);
                                } else {
                                    lineGroups.push([...currentGroup]);
                                    currentGroup = [matchIndices[i]];
                                }
                            }
                            if (currentGroup.length > 0) {
                                lineGroups.push(currentGroup);
                            }
                            
                            occurrences = lineGroups.length;
                            
                            // Create snippets and subgraphs for each occurrence
                            snippets = lineGroups.map((group, idx) => {
                                const startLine = Math.max(1, Math.min(...group));
                                const endLine = Math.min(lines.length, Math.max(...group) + 1);
                                const code = lines.slice(startLine - 1, endLine).join('\n');
                                
                                // Create a subgraph for this match
                                const relevantNodes = programGraph.nodes.filter(node => 
                                    node.line >= startLine && node.line <= endLine
                                );
                                const nodeIds = relevantNodes.map(n => n.id);
                                const relevantEdges = programGraph.edges.filter(edge => 
                                    nodeIds.includes(edge.source) && nodeIds.includes(edge.target)
                                );
                                
                                matchedSubgraphs.push({
                                    nodes: relevantNodes,
                                    edges: relevantEdges
                                });
                                
                                return {
                                    id: `${pattern.code}-${idx+1}`,
                                    lineStart: startLine,
                                    lineEnd: endLine,
                                    code: code,
                                    severity: getSeverityForPattern(pattern.code)
                                };
                            });
                        }
                    }
                    
                    return {
                        patternId: pattern.id,
                        code: pattern.code,
                        name: pattern.name,
                        description: pattern.description,
                        found,
                        occurrences,
                        snippets,
                        graphData: found && matchedSubgraphs.length > 0 ? matchedSubgraphs[0] : null,
                        patternGraph: pattern.pattern
                    };
                });
            };

            // Helper functions for pattern matching
            const getKeywordsForPattern = (patternCode) => {
                switch (patternCode) {
                    case "V-001": return ["OTE"];
                    case "V-002": return ["OTU", "seal-in", "alarm"];
                    case "V-003": return ["MOV", "PRE", "timer", "TON"];
                    case "V-004": return ["MOV 1", "safety", "bypass"];
                    case "V-006": return ["MOV", "CTU", "PRE", "counter", "timer"];
                    case "V-007": return ["forward", "reverse", "motor"];
                    case "V-009": return ["array[", "MOV", "index"];
                    case "V-010": return ["toggle", "button", "OTE"];
                    case "V-011": return ["sensor", "OTE"];
                    case "V-012": return ["PID", "MOV"];
                    case "V-013": return ["DIV", "ADD", "SUB", "math"];
                    case "V-014": return ["alarm", "OTE"];
                    default: return [patternCode];
                }
            };

            const getSeverityForPattern = (patternCode) => {
                switch (patternCode) {
                    case "V-001": return "High";
                    case "V-002": return "Medium";
                    case "V-003": return "High";
                    case "V-004": return "High";
                    case "V-005": return "Medium";
                    case "V-006": return "Medium";
                    case "V-007": return "Medium";
                    case "V-008": return "High";
                    case "V-009": return "Medium";
                    case "V-010": return "Low";
                    case "V-011": return "Medium";
                    case "V-012": return "Medium";
                    case "V-013": return "High";
                    case "V-014": return "High";
                    default: return "Medium";
                }
            };

            const handleAnalyze = () => {
                if (fileContent) {
                    setAnalyzing(true);
                    
                    // Use setTimeout to prevent UI freezing
                    setTimeout(() => {
                        try {
                            console.log("Starting analysis...");
                            
                            // Parse program graph
                            const graph = parseLadderLogic(fileContent);
                            console.log("Graph parsed:", graph);
                            setProgramGraph(graph);
                            
                            // Safety check for graph data
                            if (!graph || !graph.nodes || !graph.edges) {
                                console.error("Invalid graph data:", graph);
                                setAnalyzing(false);
                                return;
                            }
                            
                            // Run graph isomorphism analysis with error handling
                            const results = analyzeWithGraphIsomorphism(fileContent);
                            console.log("Analysis results:", results);
                            setResults(results);
                            setAnalyzing(false);
                        } catch (error) {
                            console.error("Error during analysis:", error);
                            setAnalyzing(false);
                            // In a production app, we'd show an error message to the user
                        }
                    }, 100);
                }
            };

            // Function to provide remediation advice for each vulnerability pattern
            const getRemediationForPattern = (patternCode) => {
                switch (patternCode) {
                    case "V-001":
                        return `// Add proper conditions to coil outputs
XIC System_Running
XIC Safety_Permissive
XIC Operator_Permission
OTE Critical_Output`;

                    case "V-002":
                        return `// Add proper validation for seal-in loop reset
XIC Alarm_Condition OTE Alarm_Active
XIC Alarm_Active OTE Alarm_Active    // Seal-in logic
XIC Reset_Button
XIC Operator_Authorized
XIC All_Clear_Verified
OTU Alarm_Active    // Reset with proper validation`;

                    case "V-003":
                        return `// Validate timer presets from HMI
MOV HMI_Value Temp_Timer_Value
LIM Minimum_Time Temp_Timer_Value Maximum_Time  // Range check
EQU 1 Valid_Timer
XIC Valid_Timer
MOV Temp_Timer_Value Timer1.PRE      // Only use validated value
TON Timer1`;

                    case "V-004":
                        return `// Replace blind safety overrides with proper authorization
XIC Maintenance_Mode
XIC Supervisor_Key_Switch            // Physical key authorization
TON Timeout_Timer                    // Automatic timeout
XIC Timeout_Timer.DN                 // Only active for limited time
XIC Safety_Override_Logging.DN       // Ensure logging is active
MOV 1 Safety_Bypass_Request          // Request rather than direct override`;

                    case "V-005":
                        return `// Break monolithic blocks into smaller routines
JSR Initialize_System
JSR Process_Inputs
JSR Execute_Control_Logic
JSR Process_Outputs
JSR Safety_Monitor`;

                    case "V-006":
                        return `// Add validation for timer/counter presets
MOV User_Counter_Input Temp_Counter
LIM Min_Count Temp_Counter Max_Count   // Range check
EQU 1 Valid_Counter
XIC Valid_Counter
MOV Temp_Counter CTU_1.PRE           // Only use valid counter preset
XIO Valid_Counter 
MOV Default_Count CTU_1.PRE          // Use safe default if invalid
CTU CTU_1`;

                    case "V-007":
                        return `// Add interlocks for mutually-exclusive outputs
XIC Forward_Button
XIO Motor_Reverse                    // Interlock - cannot run if reverse is on
TON Forward_Delay                    // Min delay between direction changes
XIC Forward_Delay.DN
OTE Motor_Forward

XIC Reverse_Button
XIO Motor_Forward                    // Interlock - cannot run if forward is on
TON Reverse_Delay                    // Min delay between direction changes
XIC Reverse_Delay.DN
OTE Motor_Reverse`;

                    case "V-008":
                        return `// Add PLC-side validation for HMI inputs
// HMI writes to buffer tag, PLC validates before using
MOV HMI_Buffer_Tag Temp_Value
LIM Min_Safe_Value Temp_Value Max_Safe_Value
EQU 1 Valid_HMI_Input
XIC Valid_HMI_Input
MOV Temp_Value Critical_Setpoint     // Only use if valid
XIO Valid_HMI_Input
OTE HMI_Validation_Error             // Alert if invalid`;

                    case "V-009":
                        return `// Add bounds checking for array access
MOV Index Temp_Index
LIM 0 Temp_Index Array_Size          // Bounds check
EQU 1 Valid_Index
XIC Valid_Index
MOV Array[Temp_Index] Temp_Value     // Only access array if index is valid
XIO Valid_Index
OTE Index_Out_Of_Range               // Alert on invalid index`;

                    case "V-010":
                        return `// Add debounce timer protection
XIC Button_Input
TON Debounce_Timer                   // Debounce delay
XIC Debounce_Timer.DN                // Only act after debounce time
OSR Button_Pulse                     // One-shot rising for clean pulse
XIC Button_Pulse
XIO Toggle_Output                    // Toggle current state
OTE Toggle_Output`;

                    case "V-011":
                        return `// Add plausibility cross-checks for redundant sensors
XIC Sensor_1 
XIC Sensor_2                         // Require both sensors
OTE Process_Running                  // Only run if both agree

// Check for sensor disagreement
XIC Sensor_1
XIO Sensor_2                         // Sensor 1 on, Sensor 2 off
OTE Sensor_Mismatch                  // Alert on sensor mismatch

XIO Sensor_1
XIC Sensor_2                         // Sensor 1 off, Sensor 2 on
OTE Sensor_Mismatch                  // Alert on sensor mismatch`;

                    case "V-012":
                        return `// Add physical limit clamping for PID
MOV Operator_Input Temp_Setpoint
LIM Physical_Min_Value Temp_Setpoint Physical_Max_Value  // Physical limits
EQU 1 Valid_Setpoint
XIC Valid_Setpoint
MOV Temp_Setpoint PID_Setpoint       // Only use if within limits
XIO Valid_Setpoint
OTE Setpoint_Error                   // Alert on invalid setpoint
PID PID_Controller`;

                    case "V-013":
                        return `// Add proper status bit checking for math operations
XIC Value_2_Is_Zero                  // Check for zero before division
OTE Divide_Error                     // Alert on potential divide-by-zero

XIO Value_2_Is_Zero                  // Only divide if not zero
DIV Value_1 Value_2 Result
XIC S:V                             // Check math status bit
OTE Math_Error                      // Alert on math error`;

                    case "V-014":
                        return `// Centralize alarm logic to single location
// Rung 13 - Centralized alarm logic with all required conditions
XIC Condition_1 
XIC Condition_2 
OTE System_Alarm_Internal            // Private internal alarm state

// Rung 14 - Single alarm output source
XIC System_Alarm_Internal            // Only one place to set the actual alarm
OTE System_Alarm                     // Single source of truth`;

                    default:
                        return "// No specific remediation available for this pattern";
                }
            };

            // Simplified subgraph isomorphism algorithm for pattern matching
            const isSubgraphIsomorphic = (graph, pattern) => {
                // Make sure both graphs have nodes
                if (!graph?.nodes?.length || !pattern?.nodes?.length) {
                    return false;
                }
                
                // For simple patterns, check if there's at least one node of each required type
                const nodeTypes = {};
                pattern.nodes.forEach(node => {
                    const type = node.type || 'unknown';
                    const label = node.label || '';
                    const key = `${type}-${label}`;
                    nodeTypes[key] = (nodeTypes[key] || 0) + 1;
                });
                
                // Count the occurrences of each node type in the main graph
                const graphNodeTypes = {};
                graph.nodes.forEach(node => {
                    const type = node.type || 'unknown';
                    const label = node.label || '';
                    const key = `${type}-${label}`;
                    graphNodeTypes[key] = (graphNodeTypes[key] || 0) + 1;
                });
                
                // Check if each required node type appears at least as many times as needed
                for (const [type, count] of Object.entries(nodeTypes)) {
                    if (!graphNodeTypes[type] || graphNodeTypes[type] < count) {
                        return false;
                    }
                }
                
                // For patterns with edges, check if similar connections exist
                if (pattern.edges && pattern.edges.length > 0) {
                    try {
                        const edgeTypes = {};
                        pattern.edges.forEach(edge => {
                            // Get node types of source and target
                            const sourceNode = pattern.nodes.find(n => n.id === edge.source);
                            const targetNode = pattern.nodes.find(n => n.id === edge.target);
                            if (!sourceNode || !targetNode) return;
                            
                            const sourceType = `${sourceNode.type || 'unknown'}-${sourceNode.label || ''}`;
                            const targetType = `${targetNode.type || 'unknown'}-${targetNode.label || ''}`;
                            const edgeKey = `${sourceType}->${targetType}`;
                            edgeTypes[edgeKey] = (edgeTypes[edgeKey] || 0) + 1;
                        });
                        
                        // Count similar connections in the graph
                        const graphEdgeTypes = {};
                        graph.edges.forEach(edge => {
                            const sourceNode = graph.nodes.find(n => n.id === edge.source);
                            const targetNode = graph.nodes.find(n => n.id === edge.target);
                            if (!sourceNode || !targetNode) return;
                            
                            const sourceType = `${sourceNode.type || 'unknown'}-${sourceNode.label || ''}`;
                            const targetType = `${targetNode.type || 'unknown'}-${targetNode.label || ''}`;
                            const edgeKey = `${sourceType}->${targetType}`;
                            graphEdgeTypes[edgeKey] = (graphEdgeTypes[edgeKey] || 0) + 1;
                        });
                        
                        // Check if each required edge type appears at least as many times as needed
                        for (const [type, count] of Object.entries(edgeTypes)) {
                            if (!graphEdgeTypes[type] || graphEdgeTypes[type] < count) {
                                return false;
                            }
                        }
                    } catch (error) {
                        console.error("Error in edge matching:", error);
                        // If there's an error matching edges, default to node matching only
                        return true;
                    }
                }
                
                return true;
            };

            const handleConvertXML = async () => {
                if (!file || !file.name.match(/\.(xml|l5x)$/i)) {
                    return;
                }
                
                setConvertingXML(true);
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await fetch('http://localhost:5000/convert-xml', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        setConversionResult(result);
                        
                        // Create a text file from the conversion result
                        const convertedFile = new File(
                            [result.converted], 
                            result.filename, 
                            { type: 'text/plain' }
                        );
                        
                        // Update the file and file content state
                        setFile(convertedFile);
                        setFileContent(result.converted);
                        
                        // Show success message
                        alert('File converted successfully!');
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error converting file:', error);
                    alert('Error converting file. Check the console for details.');
                } finally {
                    setConvertingXML(false);
                }
            };

            return (
                <div className="flex flex-col min-h-screen bg-gray-50">
                    <header className="bg-blue-600 text-white p-4">
                        <div className="container mx-auto">
                            <h1 className="text-2xl font-bold">Ladder Logic Security Analyzer</h1>
                            <p className="text-sm opacity-80">
                                Detect security vulnerabilities in PLC ladder logic using graph isomorphism analysis
                            </p>
                        </div>
                    </header>
                    
                    <main className="container mx-auto p-4 flex-grow">
                        {!results ? (
                            <div className="bg-white p-6 rounded-lg shadow-md">
                                <h2 className="text-xl font-semibold mb-4">Upload Ladder Logic File</h2>
                                
                                <div className="mb-4">
                                    <label 
                                        htmlFor="file-upload" 
                                        className="flex items-center justify-center w-full h-32 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-md appearance-none cursor-pointer hover:border-blue-400 focus:outline-none"
                                    >
                                        <div className="flex flex-col items-center space-y-2">
                                            <span className="font-medium text-gray-600">
                                                {file ? file.name : 'Drop files to upload or click to browse'}
                                            </span>
                                            {file && (
                                                <span className="text-xs text-gray-500">
                                                    {(file.size / 1024).toFixed(2)} KB
                                                </span>
                                            )}
                                        </div>
                                        <input 
                                            id="file-upload" 
                                            type="file" 
                                            className="hidden" 
                                            accept=".l5x,.txt,.xml" 
                                            onChange={handleFileChange}
                                        />
                                    </label>
                                </div>
                                
                                {file && file.name.match(/\.(xml|l5x)$/i) && (
                                    <div className="mb-4">
                                        <button
                                            onClick={handleConvertXML}
                                            className="w-full py-2 px-4 rounded-md text-white font-medium transition-colors bg-green-600 hover:bg-green-700 mb-2"
                                        >
                                            Convert XML to Text Format
                                        </button>
                                        <p className="text-xs text-gray-500 italic">
                                            XML files need to be converted to text format for analysis
                                        </p>
                                    </div>
                                )}
                                
                                <button
                                    onClick={handleAnalyze}
                                    disabled={!fileContent || analyzing}
                                    className={`w-full py-2 px-4 rounded-md text-white font-medium transition-colors ${
                                        !fileContent || analyzing 
                                            ? 'bg-gray-400 cursor-not-allowed' 
                                            : 'bg-blue-600 hover:bg-blue-700'
                                    }`}
                                >
                                    {analyzing ? 'Analyzing...' : 'Analyze for Vulnerabilities'}
                                </button>
                                
                                <div className="mt-8 border-t pt-6">
                                    <h3 className="text-lg font-semibold mb-4">About Graph-Based Vulnerability Detection</h3>
                                    <p className="text-sm text-gray-600 mb-4">
                                        This analyzer converts your ladder logic into a graph representation and uses graph isomorphism 
                                        techniques to identify 14 common security vulnerabilities. Here's how it works:
                                    </p>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        <div className="border rounded-md p-3 bg-gray-50">
                                            <h4 className="font-medium text-gray-800 mb-2">Step 1: Parse Ladder Logic</h4>
                                            <p className="text-xs text-gray-600">
                                                Your ladder logic is parsed to create a graph where nodes represent instructions 
                                                and edges represent the execution flow.
                                            </p>
                                        </div>
                                        <div className="border rounded-md p-3 bg-gray-50">
                                            <h4 className="font-medium text-gray-800 mb-2">Step 2: Pattern Matching</h4>
                                            <p className="text-xs text-gray-600">
                                                The analyzer uses graph isomorphism to compare your code against 
                                                known vulnerability patterns.
                                            </p>
                                        </div>
                                        <div className="border rounded-md p-3 bg-gray-50">
                                            <h4 className="font-medium text-gray-800 mb-2">Step 3: Visualization</h4>
                                            <p className="text-xs text-gray-600">
                                                Detected vulnerabilities are visualized with highlighted subgraphs showing 
                                                the problematic code structure.
                                            </p>
                                        </div>
                                        <div className="border rounded-md p-3 bg-gray-50">
                                            <h4 className="font-medium text-gray-800 mb-2">Step 4: Remediation</h4>
                                            <p className="text-xs text-gray-600">
                                                For each vulnerability, detailed remediation advice and secure code examples 
                                                are provided.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <h3 className="text-lg font-semibold mb-4">Sample Vulnerability Patterns</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-red-50 border-b px-3 py-2 text-sm font-medium">
                                                V-001: Unconditional coil overwrite
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Ladder logic that unconditionally overwrites an output coil without proper conditions:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>OTE Critical_Output</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="100" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="35" r="15" fill="#f97316" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="10">Rung</text>
                                                        <circle cx="70" cy="35" r="15" fill="#60a5fa" />
                                                        <text x="70" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="10">OTE</text>
                                                        <line x1="45" y1="35" x2="55" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrowhead)" />
                                                        <defs>
                                                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-orange-50 border-b px-3 py-2 text-sm font-medium">
                                                V-002: Shadow reset (seal-in loop)
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    A circuit that resets a seal-in loop without proper validation:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>XIC Alarm_Condition OTE Alarm_Active
XIC Alarm_Active OTE Alarm_Active
XIC Reset_Button OTU Alarm_Active</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="140" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="20" r="10" fill="#4ade80" />
                                                        <text x="30" y="20" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="70" cy="20" r="10" fill="#60a5fa" />
                                                        <text x="70" y="20" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="40" y1="20" x2="60" y2="20" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v002)" />
                                                        
                                                        <circle cx="30" cy="40" r="10" fill="#4ade80" />
                                                        <text x="30" y="40" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="70" cy="40" r="10" fill="#60a5fa" />
                                                        <text x="70" y="40" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="40" y1="40" x2="60" y2="40" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v002)" />
                                                        
                                                        <circle cx="110" cy="40" r="10" fill="#60a5fa" />
                                                        <text x="110" y="40" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTU</text>
                                                        <line x1="80" y1="40" x2="100" y2="40" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v002)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v002" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-amber-50 border-b px-3 py-2 text-sm font-medium">
                                                V-003: Timer bomb (preset from writable tag)
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Timer preset values come from HMI-writable tags without validation:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>MOV HMI_Value Timer1.PRE
TON Timer1</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="120" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">MOV</text>
                                                        <circle cx="80" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="80" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">TON</text>
                                                        <line x1="42" y1="35" x2="68" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v003)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v003" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-yellow-50 border-b px-3 py-2 text-sm font-medium">
                                                V-004: Unsafe mode override
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Using MOV 1 to override safety or diagnostic tags:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>XIC Maintenance_Mode
 MOV 1 Safety_Bypass</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="120" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="35" r="12" fill="#4ade80" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="80" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="80" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">MOV</text>
                                                        <line x1="42" y1="35" x2="68" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v004)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v004" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-lime-50 border-b px-3 py-2 text-sm font-medium">
                                                V-005: Monolithic main block
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Main routine with more than 500 nodes, making it harder to maintain and secure:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>XIC Input_1 OTE Output_1
XIC Input_2 OTE Output_2
XIC Input_3 OTE Output_3
// ... 500+ more lines ...</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="140" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="15" r="10" fill="#f97316" />
                                                        <text x="30" y="15" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">R1</text>
                                                        <circle cx="70" cy="15" r="10" fill="#4ade80" />
                                                        <text x="70" y="15" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="110" cy="15" r="10" fill="#60a5fa" />
                                                        <text x="110" y="15" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="40" y1="15" x2="60" y2="15" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v005)" />
                                                        <line x1="80" y1="15" x2="100" y2="15" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v005)" />
                                                        
                                                        <circle cx="30" cy="35" r="10" fill="#f97316" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">R2</text>
                                                        <circle cx="70" cy="35" r="10" fill="#4ade80" />
                                                        <text x="70" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="110" cy="35" r="10" fill="#60a5fa" />
                                                        <text x="110" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="40" y1="35" x2="60" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v005)" />
                                                        <line x1="80" y1="35" x2="100" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v005)" />
                                                        
                                                        <circle cx="30" cy="55" r="10" fill="#f97316" />
                                                        <text x="30" y="55" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">R...</text>
                                                        <text x="70" y="55" textAnchor="middle" dominantBaseline="middle" fill="gray" fontSize="10">...</text>
                                                        <text x="110" y="55" textAnchor="middle" dominantBaseline="middle" fill="gray" fontSize="10">...</text>
                                                        
                                                        <defs>
                                                            <marker id="arrow-v005" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-green-50 border-b px-3 py-2 text-sm font-medium">
                                                V-006: Unvalidated timer/counter preset
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Timer or counter values without validation logic:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>MOV User_Counter_Input CTU_1.PRE
CTU CTU_1</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="120" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">MOV</text>
                                                        <circle cx="80" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="80" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">CTU</text>
                                                        <line x1="42" y1="35" x2="68" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v006)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v006" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-emerald-50 border-b px-3 py-2 text-sm font-medium">
                                                V-007: Mutually-exclusive coils asserted
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Antagonistic outputs (forward/reverse) without interlocks:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>XIC Forward_Button OTE Motor_Forward
XIC Reverse_Button OTE Motor_Reverse</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="120" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="20" r="12" fill="#4ade80" />
                                                        <text x="30" y="20" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="80" cy="20" r="12" fill="#60a5fa" />
                                                        <text x="80" y="20" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="42" y1="20" x2="68" y2="20" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v007)" />
                                                        
                                                        <circle cx="30" cy="50" r="12" fill="#4ade80" />
                                                        <text x="30" y="50" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="80" cy="50" r="12" fill="#60a5fa" />
                                                        <text x="80" y="50" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="42" y1="50" x2="68" y2="50" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v007)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v007" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-teal-50 border-b px-3 py-2 text-sm font-medium">
                                                V-008: HMI blind-write
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    HMI writing to PLC variables without validation:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>// HMI_Tag directly mapped to 
// Critical_Setpoint without PLC validation</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="120" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="35" r="12" fill="#c084fc" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">HMI</text>
                                                        <circle cx="80" cy="35" r="12" fill="#c084fc" />
                                                        <text x="80" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">PLC</text>
                                                        <line x1="42" y1="35" x2="68" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v008)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v008" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-cyan-50 border-b px-3 py-2 text-sm font-medium">
                                                V-009: Out-of-bounds indirection
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Array indexing without bounds checks:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>MOV Index Array[Index]</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="100" height="70" className="overflow-visible">
                                                        <circle cx="50" cy="35" r="15" fill="#60a5fa" />
                                                        <text x="50" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="10">MOV</text>
                                                        
                                                        <defs>
                                                            <marker id="arrow-v009" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-sky-50 border-b px-3 py-2 text-sm font-medium">
                                                V-010: Rapid toggle / missing debounce
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Paired outputs without debounce timer protection:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>XIC Button_Input OTE Toggle_Output</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="120" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="35" r="12" fill="#4ade80" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="80" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="80" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="42" y1="35" x2="68" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v010)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v010" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-blue-50 border-b px-3 py-2 text-sm font-medium">
                                                V-011: Missing plausibility cross-check
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Missing validation between redundant sensor tags:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>XIC Sensor_1 OTE Process_Running</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="120" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="35" r="12" fill="#4ade80" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="80" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="80" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="42" y1="35" x2="68" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v011)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v011" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-indigo-50 border-b px-3 py-2 text-sm font-medium">
                                                V-012: No physical-limit clamp
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    PID blocks without physical limits on operator inputs:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>MOV Operator_Input PID_Setpoint
 PID PID_Controller</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="120" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="30" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">MOV</text>
                                                        <circle cx="80" cy="35" r="12" fill="#60a5fa" />
                                                        <text x="80" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">PID</text>
                                                        <line x1="42" y1="35" x2="68" y2="35" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v012)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v012" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-violet-50 border-b px-3 py-2 text-sm font-medium">
                                                V-013: Flag-blind math
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Math operations without status bit checking for alarms:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>DIV Value_1 Value_2 Result
 ADD Value_3 Value_4 Sum</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="140" height="70" className="overflow-visible">
                                                        <circle cx="40" cy="25" r="12" fill="#60a5fa" />
                                                        <text x="40" y="25" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">DIV</text>
                                                        
                                                        <circle cx="40" cy="50" r="12" fill="#60a5fa" />
                                                        <text x="40" y="50" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">ADD</text>
                                                        
                                                        <circle cx="100" cy="35" r="12" fill="#f97316" />
                                                        <text x="100" y="35" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="7">STATUS</text>
                                                        <line x1="52" y1="25" x2="88" y2="35" stroke="#94a3b8" strokeWidth="1" strokeDasharray="4" />
                                                        <line x1="52" y1="50" x2="88" y2="35" stroke="#94a3b8" strokeWidth="1" strokeDasharray="4" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v013" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border rounded-md overflow-hidden">
                                            <div className="bg-purple-50 border-b px-3 py-2 text-sm font-medium">
                                                V-014: Alert-trap bypass
                                            </div>
                                            <div className="p-3">
                                                <div className="text-xs text-gray-600 mb-2">
                                                    Alarm coil written from multiple rungs where one lacks conditions:
                                                </div>
                                                <pre className="bg-gray-100 p-2 text-xs rounded">
                                                    <code>XIC Condition_1 XIC Condition_2 OTE System_Alarm
 // Later rung with no conditions:
 OTE System_Alarm</code>
                                                </pre>
                                                <div className="h-24 bg-gray-100 rounded mt-2 flex items-center justify-center">
                                                    <svg width="140" height="70" className="overflow-visible">
                                                        <circle cx="30" cy="20" r="10" fill="#f97316" />
                                                        <text x="30" y="20" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">R1</text>
                                                        <circle cx="60" cy="20" r="10" fill="#4ade80" />
                                                        <text x="60" y="20" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="90" cy="20" r="10" fill="#4ade80" />
                                                        <text x="90" y="20" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">XIC</text>
                                                        <circle cx="120" cy="20" r="10" fill="#60a5fa" />
                                                        <text x="120" y="20" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="40" y1="20" x2="50" y2="20" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v014)" />
                                                        <line x1="70" y1="20" x2="80" y2="20" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v014)" />
                                                        <line x1="100" y1="20" x2="110" y2="20" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v014)" />
                                                        
                                                        <circle cx="30" cy="50" r="10" fill="#f97316" />
                                                        <text x="30" y="50" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">R2</text>
                                                        <circle cx="120" cy="50" r="10" fill="#60a5fa" />
                                                        <text x="120" y="50" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="8">OTE</text>
                                                        <line x1="40" y1="50" x2="110" y2="50" stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrow-v014)" />
                                                        
                                                        <defs>
                                                            <marker id="arrow-v014" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                                            </marker>
                                                        </defs>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-6 bg-blue-50 p-4 rounded-md text-sm">
                                    <h4 className="font-medium text-blue-800 mb-1">Try Sample Files</h4>
                                    <p className="text-blue-700 mb-2">
                                        For testing, use the provided sample files:
                                    </p>
                                    <ul className="list-disc list-inside text-blue-600 text-xs">
                                        <li><strong>sample_ladder.txt</strong> - Contains examples of all 14 vulnerability patterns</li>
                                        <li><strong>sample_secure_ladder.txt</strong> - Contains secure remediated versions</li>
                                    </ul>
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                {/* Results Summary Panel */}
                                <div className="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                                    <h2 className="text-xl font-semibold mb-4">Analysis Results</h2>
                                    
                                    <div className="mb-6">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-medium">File Analyzed:</span>
                                            <span>{file.name}</span>
                                        </div>
                                        <div className="flex justify-between mb-2">
                                            <span className="font-medium">Total Vulnerabilities:</span>
                                            <span className="font-bold text-red-600">
                                                {results.filter(r => r.found).reduce((sum, r) => sum + r.occurrences, 0)}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="font-medium">Patterns Detected:</span>
                                            <span>{results.filter(r => r.found).length} of {vulnerabilityPatterns.length}</span>
                                        </div>
                                    </div>
                                    
                                    <h3 className="font-semibold mb-2">Detected Vulnerabilities</h3>
                                    <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                        {results
                                            .filter(result => result.found)
                                            .map(result => (
                                                <div 
                                                    key={result.code}
                                                    className={`p-3 rounded-md cursor-pointer transition-colors ${
                                                        selectedVulnerability?.code === result.code 
                                                            ? 'bg-blue-100 border-l-4 border-blue-600' 
                                                            : 'bg-gray-100 hover:bg-gray-200'
                                                    }`}
                                                    onClick={() => setSelectedVulnerability(result)}
                                                >
                                                    <div className="flex justify-between items-center">
                                                        <div className="font-medium">{result.code}</div>
                                                        <div className="text-xs px-2 py-1 rounded-full bg-red-100 text-red-800">
                                                            {result.occurrences} {result.occurrences === 1 ? 'instance' : 'instances'}
                                                        </div>
                                                    </div>
                                                    <div className="text-sm text-gray-700">{result.name}</div>
                                                </div>
                                            ))}
                                    </div>
                                    
                                    <h3 className="font-semibold mt-4 mb-2">Passed Checks</h3>
                                    <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                        {results
                                            .filter(result => !result.found)
                                            .map(result => (
                                                <div 
                                                    key={result.code}
                                                    className={`p-3 rounded-md cursor-pointer transition-colors ${
                                                        selectedVulnerability?.code === result.code 
                                                            ? 'bg-blue-100 border-l-4 border-blue-600' 
                                                            : 'bg-green-50 hover:bg-green-100'
                                                    }`}
                                                    onClick={() => setSelectedVulnerability(result)}
                                                >
                                                    <div className="flex justify-between items-center">
                                                        <div className="font-medium">{result.code}</div>
                                                        <div className="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">
                                                            Passed
                                                        </div>
                                                    </div>
                                                    <div className="text-sm text-gray-700">{result.name}</div>
                                                </div>
                                            ))}
                                    </div>
                                    
                                    <button
                                        onClick={() => {
                                            setResults(null);
                                            setSelectedVulnerability(null);
                                            setFile(null);
                                            setFileContent(null);
                                            setProgramGraph(null);
                                            setActiveTab('overview');
                                        }}
                                        className="mt-4 w-full py-2 px-4 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-800 font-medium transition-colors"
                                    >
                                        Analyze Another File
                                    </button>
                                </div>
                                
                                {/* Vulnerability Details Panel */}
                                <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow-md overflow-y-auto" style={{ maxHeight: "90vh" }}>
                                    {selectedVulnerability ? (
                                        <>
                                            <div className="border-b pb-4 mb-4">
                                                <h2 className="text-xl font-semibold flex items-center">
                                                    <span className="w-6 h-6 rounded-full flex items-center justify-center mr-2" 
                                                          style={{backgroundColor: vulnerabilityPatterns.find(p => p.code === selectedVulnerability.code)?.color || '#000'}}>
                                                    </span>
                                                    {selectedVulnerability.code}: {selectedVulnerability.name}
                                                </h2>
                                                <p className="text-gray-600 mt-1">
                                                    {selectedVulnerability.description}
                                                </p>
                                                
                                                <div className={`mt-3 text-sm px-3 py-1.5 rounded inline-flex items-center ${
                                                    selectedVulnerability.found 
                                                        ? 'bg-red-50 text-red-700' 
                                                        : 'bg-green-50 text-green-700'
                                                }`}>
                                                    {selectedVulnerability.found 
                                                        ? <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                          </svg>
                                                        : <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                                                          </svg>
                                                    }
                                                    {selectedVulnerability.found 
                                                        ? `Vulnerability detected: ${selectedVulnerability.occurrences} ${selectedVulnerability.occurrences === 1 ? 'instance' : 'instances'}`
                                                        : 'No vulnerability detected: This check passed'
                                                    }
                                                </div>
                                            </div>
                                            
                                            {/* Graph Visualization */}
                                            <div className="mb-6">
                                                <h3 className="font-semibold mb-2">Vulnerability Graph Pattern</h3>
                                                <p className="text-sm text-gray-600 mb-2">
                                                    This is the graph pattern that was {selectedVulnerability.found ? 'detected' : 'checked for'} in your ladder logic:
                                                </p>
                                                <div className="mb-6">
                                                    <GraphViz 
                                                        graphData={selectedVulnerability.patternGraph} 
                                                        highlightedNodes={selectedVulnerability.patternGraph?.nodes.map(n => n.id) || []}
                                                    />
                                                </div>
                                                
                                                {selectedVulnerability.found && (
                                                    <>
                                                        <h3 className="font-semibold mb-2">Detected Subgraph in Your Code</h3>
                                                        <p className="text-sm text-gray-600 mb-2">
                                                            This is how the vulnerability appears in your ladder logic:
                                                        </p>
                                                        <div className="mb-6">
                                                            <GraphViz 
                                                                graphData={selectedVulnerability.graphData}
                                                                highlightedNodes={selectedVulnerability.patternGraph?.nodes.map((n, i) => 
                                                                    selectedVulnerability.graphData?.nodes[i]?.id
                                                                ) || []}
                                                            />
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                            
                                            {selectedVulnerability.found ? (
                                                <div>
                                                    <h3 className="font-semibold mb-2">Detected Instances ({selectedVulnerability.occurrences})</h3>
                                                    <div className="space-y-4">
                                                        {selectedVulnerability.snippets.map(snippet => (
                                                            <div 
                                                                key={snippet.id} 
                                                                className="border rounded-md overflow-hidden"
                                                            >
                                                                <div className="flex justify-between items-center bg-gray-100 px-3 py-1.5 border-b">
                                                                    <div className="text-sm">
                                                                        Lines {snippet.lineStart}-{snippet.lineEnd}
                                                                    </div>
                                                                    <div className={`text-xs px-2 py-0.5 rounded-full ${
                                                                        snippet.severity === 'High' 
                                                                            ? 'bg-red-100 text-red-800'
                                                                            : snippet.severity === 'Medium'
                                                                                ? 'bg-yellow-100 text-yellow-800'
                                                                                : 'bg-blue-100 text-blue-800'
                                                                    }`}>
                                                                        {snippet.severity} Severity
                                                                    </div>
                                                                </div>
                                                                <pre className="bg-gray-50 p-3 text-sm overflow-x-auto">
                                                                    <code>{snippet.code}</code>
                                                                </pre>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="bg-green-50 p-4 rounded-md border border-green-200">
                                                    <h3 className="font-semibold mb-2 text-green-800"> No Vulnerability Detected</h3>
                                                    <p className="text-green-700 mb-3">
                                                        Your code passed this security check. Here's what we looked for:
                                                    </p>
                                                    <div className="flex items-start mb-2">
                                                        <div className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold mr-2 mt-0.5">CHECKED</div>
                                                        <div className="text-sm text-gray-700">
                                                            {selectedVulnerability.description}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* Remediation advice */}
                                            <div className="mt-6 pt-4 border-t">
                                                <h3 className="font-semibold mb-2">
                                                    {selectedVulnerability.found 
                                                        ? 'Recommended Fix' 
                                                        : 'Secure Coding Pattern Example'
                                                    }
                                                </h3>
                                                <div className={`p-4 ${selectedVulnerability.found ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200'} rounded-md`}>
                                                    <pre className="text-sm">
                                                        <code>{getRemediationForPattern(selectedVulnerability.code)}</code>
                                                    </pre>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="border-b pb-4 mb-4">
                                                <h2 className="text-xl font-semibold">Program Overview</h2>
                                                <p className="text-gray-600 mt-1">
                                                    Graph representation of your ladder logic program. Select a vulnerability from the left panel to see details.
                                                </p>
                                            </div>
                                            
                                            {/* Tab navigation */}
                                            <div className="flex space-x-2 mb-4 border-b">
                                                <button 
                                                    className={`px-4 py-2 text-gray-700 font-medium border-b-2 ${
                                                        activeTab === 'overview' 
                                                            ? 'border-blue-500 text-blue-700' 
                                                            : 'border-transparent hover:border-gray-300 hover:text-gray-900'
                                                    }`}
                                                    onClick={() => setActiveTab('overview')}
                                                >
                                                    Overview
                                                </button>
                                                <button 
                                                    className={`px-4 py-2 text-gray-700 font-medium border-b-2 ${
                                                        activeTab === 'ladder-logic' 
                                                            ? 'border-blue-500 text-blue-700' 
                                                            : 'border-transparent hover:border-gray-300 hover:text-gray-900'
                                                    }`}
                                                    onClick={() => setActiveTab('ladder-logic')}
                                                >
                                                    View Ladder Logic
                                                </button>
                                            </div>

                                            {activeTab === 'ladder-logic' ? (
                                                <div className="bg-white">
                                                    <h3 className="font-semibold mb-2">Ladder Logic Code</h3>
                                                    <pre className="bg-gray-50 p-4 rounded-md overflow-auto text-xs font-mono" style={{ maxHeight: "600px" }}>
                                                        {fileContent}
                                                    </pre>
                                                </div>
                                            ) : (
                                                <>
                                                    {/* Program Graph Visualization */}
                                                    <div className="mb-6">
                                                        <h3 className="font-semibold mb-2">Program Structure</h3>
                                                        <div className="mb-4" style={{ height: "400px" }}>
                                                            <GraphViz graphData={programGraph} />
                                                        </div>
                                                        <div className="flex flex-wrap gap-2 mt-2 text-xs">
                                                            <div className="flex items-center">
                                                                <span className="inline-block w-3 h-3 bg-blue-400 mr-1 rounded-full"></span>
                                                                <span>Instructions</span>
                                                            </div>
                                                            <div className="flex items-center">
                                                                <span className="inline-block w-3 h-3 bg-green-400 mr-1 rounded-full"></span>
                                                                <span>Conditions</span>
                                                            </div>
                                                            <div className="flex items-center">
                                                                <span className="inline-block w-3 h-3 bg-orange-400 mr-1 rounded-full"></span>
                                                                <span>Rungs</span>
                                                            </div>
                                                            <div className="flex items-center">
                                                                <span className="inline-block w-3 h-3 bg-purple-400 mr-1 rounded-full"></span>
                                                                <span>Special</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className="mt-6">
                                                        <h3 className="font-semibold mb-2">Security Analysis Summary</h3>
                                                        <div className="bg-gray-50 p-4 rounded-md border">
                                                            <p className="mb-4">
                                                                Based on the "Secure PLC Coding Practices: Top 20 List", we've analyzed your ladder logic code for 14 common security vulnerabilities using graph isomorphism. 
                                                                Select a detected vulnerability from the left panel to see details and remediation suggestions.
                                                            </p>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <div className="bg-white p-3 rounded border">
                                                                    <div className="text-lg font-medium text-red-600 mb-1">
                                                                        {results.filter(r => r.found).reduce((sum, r) => sum + r.occurrences, 0)}
                                                                    </div>
                                                                    <div className="text-sm text-gray-600">Total Issues Found</div>
                                                                </div>
                                                                <div className="bg-white p-3 rounded border">
                                                                    <div className="text-lg font-medium text-green-600 mb-1">
                                                                        {results.filter(r => !r.found).length}/{vulnerabilityPatterns.length}
                                                                    </div>
                                                                    <div className="text-sm text-gray-600">Passed Checks</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                    
                    <footer className="bg-gray-800 text-white p-4 text-center text-sm">
                        <p>Ladder Logic Security Analyzer - Based on Top 20 Secure PLC Coding Practices</p>
                        <p className="text-gray-400 text-xs mt-1">
                            This tool uses graph isomorphism techniques to detect security vulnerabilities in PLC code
                        </p>
                    </footer>
                </div>
            );
        };

        // Error handling for React rendering
        try {
            ReactDOM.render(<App />, document.getElementById('root'));
            console.log("App rendered successfully");
        } catch (error) {
            console.error("Error rendering app:", error);
            document.getElementById('root').innerHTML = `
                <div class="p-6 bg-red-100 text-red-700">
                    <h2 class="text-xl font-bold mb-4">Error Loading Application</h2>
                    <p>${error.message}</p>
                </div>
            `;
        }
    </script>
</body>
</html> 